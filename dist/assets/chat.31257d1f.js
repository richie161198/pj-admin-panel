import{d as ce,r as u,Z as de,b as le,j as t,L as ue,c as i,B as C,I as B,C as L,Q as A}from"./index.ce738da1.js";import{A as Y}from"./Avatar.031008bd.js";import{B as M}from"./Badge.eb576f68.js";import{l as me}from"./index.6a354765.js";const ge=ce.injectEndpoints({endpoints:o=>({getAllChats:o.query({query:({page:e=1,limit:c=20,status:a,priority:m,category:x}={})=>{const d=new URLSearchParams;return e&&d.append("page",e),c&&d.append("limit",c),a&&d.append("status",a),m&&d.append("priority",m),x&&d.append("category",x),`/chat/chats?${d.toString()}`},providesTags:["Chat"]}),getChatStats:o.query({query:()=>"/chat/chats/stats",providesTags:["Chat"]}),getChatById:o.query({query:e=>`/chat/chats/${e}`,providesTags:(e,c,a)=>[{type:"Chat",id:a}]}),createChat:o.mutation({query:e=>({url:"/chat/chats",method:"POST",body:e}),invalidatesTags:["Chat"]}),sendMessage:o.mutation({query:({chatId:e,message:c,messageType:a="text",attachments:m=[]})=>({url:`/chat/chats/${e}/messages`,method:"POST",body:{message:c,messageType:a,attachments:m}}),invalidatesTags:(e,c,{chatId:a})=>[{type:"Chat",id:a}]}),markAsRead:o.mutation({query:e=>({url:`/chat/chats/${e}/read`,method:"PUT"}),invalidatesTags:(e,c,a)=>[{type:"Chat",id:a}]}),assignChat:o.mutation({query:({chatId:e,adminId:c})=>({url:`/chat/chats/${e}/assign`,method:"PUT",body:{adminId:c}}),invalidatesTags:(e,c,{chatId:a})=>[{type:"Chat",id:a}]}),updateChatStatus:o.mutation({query:({chatId:e,status:c,priority:a,category:m,tags:x})=>({url:`/chat/chats/${e}/status`,method:"PUT",body:{status:c,priority:a,category:m,tags:x}}),invalidatesTags:(e,c,{chatId:a})=>[{type:"Chat",id:a}]}),closeChat:o.mutation({query:e=>({url:`/chat/chats/${e}/close`,method:"PUT"}),invalidatesTags:(e,c,a)=>[{type:"Chat",id:a}]})})}),{useGetAllChatsQuery:pe,useGetChatStatsQuery:Me,useGetChatByIdQuery:he,useCreateChatMutation:Ue,useSendMessageMutation:fe,useMarkAsReadMutation:ye,useAssignChatMutation:xe,useUpdateChatStatusMutation:ve,useCloseChatMutation:Ie}=ge,Ne=()=>{const[o,e]=u.exports.useState(null),[c,a]=u.exports.useState(!1),[m,x]=u.exports.useState([]),d=u.exports.useRef(null);u.exports.useEffect(()=>{const n=de();if(!n)return;const p=me("https://www.preciousgoldsmith.net",{auth:{token:n},transports:["websocket","polling"],reconnection:!0,reconnectionAttempts:5,reconnectionDelay:1e3});return d.current=p,e(p),p.on("connect",()=>{console.log("Socket connected"),a(!0)}),p.on("disconnect",()=>{console.log("Socket disconnected"),a(!1)}),p.on("connect_error",v=>{console.error("Socket connection error:",v),a(!1)}),()=>{d.current&&d.current.disconnect()}},[]);const w=(n,g)=>{o&&o.on(n,g)},U=(n,g)=>{o&&o.off(n,g)},y=(n,g)=>{o&&o.emit(n,g)};return{socket:o,isConnected:c,onlineUsers:m,on:w,off:U,emit:y,joinChat:n=>{y("join_chat",n)},sendMessage:(n,g,p="text",v=[])=>{y("send_message",{chatId:n,message:g,messageType:p,attachments:v})},markAsRead:n=>{y("mark_read",{chatId:n})},setTyping:(n,g)=>{y("typing",{chatId:n,isTyping:g})},setUserStatus:n=>{y("user_status",{isOnline:n})}}},Re=()=>{var F,V,Z,H,J,K,W,X;const o=le(),[e,c]=u.exports.useState(null),[a,m]=u.exports.useState(""),[x,d]=u.exports.useState(!1),[w,U]=u.exports.useState([]),y=u.exports.useRef(null),I=u.exports.useRef(null),{socket:S,isConnected:R,on:N,off:b,joinChat:n,sendMessage:g,markAsRead:p,setTyping:v}=Ne(),{data:_,isLoading:ee,refetch:q}=pe({page:1,limit:50}),{data:$,isLoading:be,refetch:P}=he(e==null?void 0:e.id,{skip:!(e!=null&&e.id)}),[se]=fe(),[z]=ye();xe();const[te]=ve(),E=((F=_==null?void 0:_.data)==null?void 0:F.chats)||[],r=$==null?void 0:$.data,ae=()=>{var s;(s=y.current)==null||s.scrollIntoView({behavior:"smooth"})};u.exports.useEffect(()=>{ae()},[r==null?void 0:r.messages]),u.exports.useEffect(()=>{if(!S)return;const s=l=>{l.chatId===(e==null?void 0:e.id)&&P(),q()},h=l=>{l.chatId===(e==null?void 0:e.id)&&U(j=>{const f=j.filter(oe=>oe.userId!==l.userId);return l.isTyping?[...f,{userId:l.userId,userName:l.userName}]:f})},k=l=>{l.chatId===(e==null?void 0:e.id)&&P()},T=l=>{A.info(`New message from ${l.sender}: ${l.message}`)};return N("new_message",s),N("user_typing",h),N("messages_read",k),N("chat_notification",T),()=>{b("new_message",s),b("user_typing",h),b("messages_read",k),b("chat_notification",T)}},[S,e,N,b,P,q]),u.exports.useEffect(()=>{(e==null?void 0:e.id)&&S&&R&&n(e.id)},[e,S,n,R]),u.exports.useEffect(()=>{(e==null?void 0:e.id)&&r&&(p(e.id),z(e.id))},[e,r,p,z]);const re=async s=>{if(s.preventDefault(),!(!a.trim()||!(e!=null&&e.id)))try{g(e.id,a.trim()),await se({chatId:e.id,message:a.trim()}),m(""),d(!1),v(e.id,!1)}catch{A.error("Failed to send message")}},ne=s=>{m(s.target.value),!x&&(e==null?void 0:e.id)&&(d(!0),v(e.id,!0)),I.current&&clearTimeout(I.current),I.current=setTimeout(()=>{d(!1),e!=null&&e.id&&v(e.id,!1)},3e3)},ie=s=>{c(s),m(""),d(!1),U([])},Q=async(s,h)=>{try{await te({chatId:s,status:h}),A.success("Chat status updated"),q()}catch{A.error("Failed to update chat status")}},D=s=>new Date(s).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),G=s=>{switch(s){case"open":return"success";case"closed":return"danger";case"pending":return"warning";case"resolved":return"info";default:return"secondary"}},O=s=>{switch(s){case"urgent":return"danger";case"high":return"warning";case"medium":return"info";case"low":return"success";default:return"secondary"}};return ee?t("div",{className:"flex justify-center items-center h-64",children:t(ue,{})}):i("div",{className:"space-y-6",children:[i("div",{className:"flex justify-between items-center",children:[i("div",{children:[t("h1",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:"Chat Support"}),i("p",{className:"text-gray-600 dark:text-gray-400",children:[R?"Connected":"Disconnected"," \u2022 ",E.length," active chats"]})]}),i(C,{onClick:()=>o("/dashboard"),className:"btn btn-outline",children:[t(B,{icon:"ph:arrow-left",className:"mr-2"}),"Back to Dashboard"]})]}),i("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6 h-[calc(100vh-200px)]",children:[t("div",{className:"lg:col-span-1",children:t(L,{title:"Active Chats",className:"h-full",children:t("div",{className:"space-y-2 max-h-[calc(100vh-300px)] overflow-y-auto",children:E.map(s=>{var h,k,T,l,j;return t("div",{onClick:()=>ie(s),className:`p-3 rounded-lg cursor-pointer transition-colors ${(e==null?void 0:e.id)===s._id?"bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800":"hover:bg-gray-50 dark:hover:bg-gray-800"}`,children:i("div",{className:"flex items-center space-x-3",children:[t(Y,{src:(k=(h=s.participants.find(f=>f.role==="user"))==null?void 0:h.userId)==null?void 0:k.profilePhoto,alt:"User",size:"sm"}),i("div",{className:"flex-1 min-w-0",children:[i("div",{className:"flex items-center justify-between",children:[t("h3",{className:"text-sm font-medium text-gray-900 dark:text-white truncate",children:((l=(T=s.participants.find(f=>f.role==="user"))==null?void 0:T.userId)==null?void 0:l.name)||"Unknown User"}),t("span",{className:"text-xs text-gray-500 dark:text-gray-400",children:D(s.updatedAt)})]}),i("div",{className:"flex items-center space-x-2 mt-1",children:[t(M,{color:G(s.status),size:"sm",children:s.status}),t(M,{color:O(s.priority),size:"sm",children:s.priority}),s.messages.filter(f=>!f.isRead).length>0&&t(M,{color:"danger",size:"sm",children:s.messages.filter(f=>!f.isRead).length})]}),t("p",{className:"text-xs text-gray-500 dark:text-gray-400 truncate mt-1",children:((j=s.messages[s.messages.length-1])==null?void 0:j.message)||"No messages"})]})]})},s._id)})})})}),t("div",{className:"lg:col-span-2",children:e?i(L,{className:"h-full flex flex-col",children:[i("div",{className:"flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700",children:[i("div",{className:"flex items-center space-x-3",children:[t(Y,{src:(H=(Z=(V=r==null?void 0:r.participants)==null?void 0:V.find(s=>s.role==="user"))==null?void 0:Z.userId)==null?void 0:H.profilePhoto,alt:"User",size:"sm"}),i("div",{children:[t("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:((W=(K=(J=r==null?void 0:r.participants)==null?void 0:J.find(s=>s.role==="user"))==null?void 0:K.userId)==null?void 0:W.name)||"Unknown User"}),i("div",{className:"flex items-center space-x-2",children:[t(M,{color:G(r==null?void 0:r.status),size:"sm",children:r==null?void 0:r.status}),t(M,{color:O(r==null?void 0:r.priority),size:"sm",children:r==null?void 0:r.priority})]})]})]}),i("div",{className:"flex items-center space-x-2",children:[t(C,{onClick:()=>Q(e.id,"resolved"),className:"btn btn-sm btn-outline-success",children:"Resolve"}),t(C,{onClick:()=>Q(e.id,"closed"),className:"btn btn-sm btn-outline-danger",children:"Close"})]})]}),i("div",{className:"flex-1 p-4 overflow-y-auto space-y-4",children:[(X=r==null?void 0:r.messages)==null?void 0:X.map((s,h)=>t("div",{className:`flex ${s.senderRole==="admin"?"justify-end":"justify-start"}`,children:i("div",{className:`max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${s.senderRole==="admin"?"bg-blue-500 text-white":"bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white"}`,children:[t("p",{className:"text-sm",children:s.message}),t("p",{className:"text-xs opacity-70 mt-1",children:D(s.timestamp)})]})},h)),w.length>0&&t("div",{className:"flex justify-start",children:t("div",{className:"bg-gray-100 dark:bg-gray-700 px-4 py-2 rounded-lg",children:i("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:[w.map(s=>s.userName).join(", ")," ",w.length===1?"is":"are"," typing..."]})})}),t("div",{ref:y})]}),t("form",{onSubmit:re,className:"p-4 border-t border-gray-200 dark:border-gray-700",children:i("div",{className:"flex items-center space-x-2",children:[t("input",{type:"text",value:a,onChange:ne,placeholder:"Type a message...",className:"flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-slate-700 dark:text-white"}),t(C,{type:"submit",disabled:!a.trim(),className:"btn btn-primary",children:t(B,{icon:"ph:paper-plane-tilt"})})]})})]}):t(L,{className:"h-full flex items-center justify-center",children:i("div",{className:"text-center",children:[t(B,{icon:"ph:chat-circle",className:"text-6xl text-gray-400 mb-4"}),t("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-2",children:"Select a chat to start conversation"}),t("p",{className:"text-gray-500 dark:text-gray-400",children:"Choose a chat from the list to view messages"})]})})})]})]})};export{Re as default};
