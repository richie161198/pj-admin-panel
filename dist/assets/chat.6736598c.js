import{d as ce,r as m,b as de,j as t,L as le,c as i,B as j,I as P,C as B,Q as _}from"./index.db93dc89.js";import{A as Z}from"./Avatar.f41da466.js";import{B as M}from"./Badge.da9404d7.js";import{l as ue}from"./index.6a354765.js";const me=ce.injectEndpoints({endpoints:o=>({getAllChats:o.query({query:({page:e=1,limit:c=20,status:a,priority:g,category:y}={})=>{const l=new URLSearchParams;return e&&l.append("page",e),c&&l.append("limit",c),a&&l.append("status",a),g&&l.append("priority",g),y&&l.append("category",y),`/chat/chats?${l.toString()}`},providesTags:["Chat"]}),getChatStats:o.query({query:()=>"/chat/chats/stats",providesTags:["Chat"]}),getChatById:o.query({query:e=>`/chat/chats/${e}`,providesTags:(e,c,a)=>[{type:"Chat",id:a}]}),createChat:o.mutation({query:e=>({url:"/chat/chats",method:"POST",body:e}),invalidatesTags:["Chat"]}),sendMessage:o.mutation({query:({chatId:e,message:c,messageType:a="text",attachments:g=[]})=>({url:`/chat/chats/${e}/messages`,method:"POST",body:{message:c,messageType:a,attachments:g}}),invalidatesTags:(e,c,{chatId:a})=>[{type:"Chat",id:a}]}),markAsRead:o.mutation({query:e=>({url:`/chat/chats/${e}/read`,method:"PUT"}),invalidatesTags:(e,c,a)=>[{type:"Chat",id:a}]}),assignChat:o.mutation({query:({chatId:e,adminId:c})=>({url:`/chat/chats/${e}/assign`,method:"PUT",body:{adminId:c}}),invalidatesTags:(e,c,{chatId:a})=>[{type:"Chat",id:a}]}),updateChatStatus:o.mutation({query:({chatId:e,status:c,priority:a,category:g,tags:y})=>({url:`/chat/chats/${e}/status`,method:"PUT",body:{status:c,priority:a,category:g,tags:y}}),invalidatesTags:(e,c,{chatId:a})=>[{type:"Chat",id:a}]}),closeChat:o.mutation({query:e=>({url:`/chat/chats/${e}/close`,method:"PUT"}),invalidatesTags:(e,c,a)=>[{type:"Chat",id:a}]})})}),{useGetAllChatsQuery:ge,useGetChatStatsQuery:Te,useGetChatByIdQuery:pe,useCreateChatMutation:Me,useSendMessageMutation:he,useMarkAsReadMutation:fe,useAssignChatMutation:ye,useUpdateChatStatusMutation:xe,useCloseChatMutation:Ie}=me,ve=()=>{const[o,e]=m.exports.useState(null),[c,a]=m.exports.useState(!1),[g,y]=m.exports.useState([]),l=m.exports.useRef(null);m.exports.useEffect(()=>{const n=localStorage.getItem("precious_jewels_ad_token");if(!n)return;const d=ue("http://localhost:4000",{auth:{token:n},transports:["websocket","polling"]});return l.current=d,e(d),d.on("connect",()=>{console.log("Socket connected"),a(!0)}),d.on("disconnect",()=>{console.log("Socket disconnected"),a(!1)}),d.on("connect_error",N=>{console.error("Socket connection error:",N),a(!1)}),()=>{l.current&&l.current.disconnect()}},[]);const k=(n,d)=>{o&&o.on(n,d)},I=(n,d)=>{o&&o.off(n,d)},f=(n,d)=>{o&&o.emit(n,d)};return{socket:o,isConnected:c,onlineUsers:g,on:k,off:I,emit:f,joinChat:n=>{f("join_chat",n)},sendMessage:(n,d,N="text",w=[])=>{f("send_message",{chatId:n,message:d,messageType:N,attachments:w})},markAsRead:n=>{f("mark_read",{chatId:n})},setTyping:(n,d)=>{f("typing",{chatId:n,isTyping:d})},setUserStatus:n=>{f("user_status",{isOnline:n})}}},Re=()=>{var F,V,H,J,K,W,X,Y;const o=de(),[e,c]=m.exports.useState(null),[a,g]=m.exports.useState(""),[y,l]=m.exports.useState(!1),[k,I]=m.exports.useState([]),f=m.exports.useRef(null),R=m.exports.useRef(null),{socket:S,isConnected:L,on:x,off:v,joinChat:n,sendMessage:d,markAsRead:N,setTyping:w}=ve(),{data:C,isLoading:ee,refetch:A}=ge({page:1,limit:50}),{data:q,isLoading:Ne,refetch:$}=pe(e==null?void 0:e.id,{skip:!(e!=null&&e.id)}),[se]=he(),[z]=fe();ye();const[te]=xe(),E=((F=C==null?void 0:C.data)==null?void 0:F.chats)||[],r=q==null?void 0:q.data,ae=()=>{var s;(s=f.current)==null||s.scrollIntoView({behavior:"smooth"})};m.exports.useEffect(()=>{ae()},[r==null?void 0:r.messages]),m.exports.useEffect(()=>{if(!S)return;const s=u=>{u.chatId===(e==null?void 0:e.id)&&$(),A()},p=u=>{u.chatId===(e==null?void 0:e.id)&&I(U=>{const h=U.filter(oe=>oe.userId!==u.userId);return u.isTyping?[...h,{userId:u.userId,userName:u.userName}]:h})},b=u=>{u.chatId===(e==null?void 0:e.id)&&$()},T=u=>{_.info(`New message from ${u.sender}: ${u.message}`)};return x("new_message",s),x("user_typing",p),x("messages_read",b),x("chat_notification",T),()=>{v("new_message",s),v("user_typing",p),v("messages_read",b),v("chat_notification",T)}},[S,e,x,v,$,A]),m.exports.useEffect(()=>{(e==null?void 0:e.id)&&S&&n(e.id)},[e,S,n]),m.exports.useEffect(()=>{(e==null?void 0:e.id)&&r&&(N(e.id),z(e.id))},[e,r,N,z]);const re=async s=>{if(s.preventDefault(),!(!a.trim()||!(e!=null&&e.id)))try{d(e.id,a.trim()),await se({chatId:e.id,message:a.trim()}),g(""),l(!1),w(e.id,!1)}catch{_.error("Failed to send message")}},ne=s=>{g(s.target.value),!y&&(e==null?void 0:e.id)&&(l(!0),w(e.id,!0)),R.current&&clearTimeout(R.current),R.current=setTimeout(()=>{l(!1),e!=null&&e.id&&w(e.id,!1)},3e3)},ie=s=>{c(s),g(""),l(!1),I([])},Q=async(s,p)=>{try{await te({chatId:s,status:p}),_.success("Chat status updated"),A()}catch{_.error("Failed to update chat status")}},G=s=>new Date(s).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),O=s=>{switch(s){case"open":return"success";case"closed":return"danger";case"pending":return"warning";case"resolved":return"info";default:return"secondary"}},D=s=>{switch(s){case"urgent":return"danger";case"high":return"warning";case"medium":return"info";case"low":return"success";default:return"secondary"}};return ee?t("div",{className:"flex justify-center items-center h-64",children:t(le,{})}):i("div",{className:"space-y-6",children:[i("div",{className:"flex justify-between items-center",children:[i("div",{children:[t("h1",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:"Chat Support"}),i("p",{className:"text-gray-600 dark:text-gray-400",children:[L?"Connected":"Disconnected"," \u2022 ",E.length," active chats"]})]}),i(j,{onClick:()=>o("/dashboard"),className:"btn btn-outline",children:[t(P,{icon:"ph:arrow-left",className:"mr-2"}),"Back to Dashboard"]})]}),i("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6 h-[calc(100vh-200px)]",children:[t("div",{className:"lg:col-span-1",children:t(B,{title:"Active Chats",className:"h-full",children:t("div",{className:"space-y-2 max-h-[calc(100vh-300px)] overflow-y-auto",children:E.map(s=>{var p,b,T,u,U;return t("div",{onClick:()=>ie(s),className:`p-3 rounded-lg cursor-pointer transition-colors ${(e==null?void 0:e.id)===s._id?"bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800":"hover:bg-gray-50 dark:hover:bg-gray-800"}`,children:i("div",{className:"flex items-center space-x-3",children:[t(Z,{src:(b=(p=s.participants.find(h=>h.role==="user"))==null?void 0:p.userId)==null?void 0:b.profilePhoto,alt:"User",size:"sm"}),i("div",{className:"flex-1 min-w-0",children:[i("div",{className:"flex items-center justify-between",children:[t("h3",{className:"text-sm font-medium text-gray-900 dark:text-white truncate",children:((u=(T=s.participants.find(h=>h.role==="user"))==null?void 0:T.userId)==null?void 0:u.name)||"Unknown User"}),t("span",{className:"text-xs text-gray-500 dark:text-gray-400",children:G(s.updatedAt)})]}),i("div",{className:"flex items-center space-x-2 mt-1",children:[t(M,{color:O(s.status),size:"sm",children:s.status}),t(M,{color:D(s.priority),size:"sm",children:s.priority}),s.messages.filter(h=>!h.isRead).length>0&&t(M,{color:"danger",size:"sm",children:s.messages.filter(h=>!h.isRead).length})]}),t("p",{className:"text-xs text-gray-500 dark:text-gray-400 truncate mt-1",children:((U=s.messages[s.messages.length-1])==null?void 0:U.message)||"No messages"})]})]})},s._id)})})})}),t("div",{className:"lg:col-span-2",children:e?i(B,{className:"h-full flex flex-col",children:[i("div",{className:"flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700",children:[i("div",{className:"flex items-center space-x-3",children:[t(Z,{src:(J=(H=(V=r==null?void 0:r.participants)==null?void 0:V.find(s=>s.role==="user"))==null?void 0:H.userId)==null?void 0:J.profilePhoto,alt:"User",size:"sm"}),i("div",{children:[t("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:((X=(W=(K=r==null?void 0:r.participants)==null?void 0:K.find(s=>s.role==="user"))==null?void 0:W.userId)==null?void 0:X.name)||"Unknown User"}),i("div",{className:"flex items-center space-x-2",children:[t(M,{color:O(r==null?void 0:r.status),size:"sm",children:r==null?void 0:r.status}),t(M,{color:D(r==null?void 0:r.priority),size:"sm",children:r==null?void 0:r.priority})]})]})]}),i("div",{className:"flex items-center space-x-2",children:[t(j,{onClick:()=>Q(e.id,"resolved"),className:"btn btn-sm btn-outline-success",children:"Resolve"}),t(j,{onClick:()=>Q(e.id,"closed"),className:"btn btn-sm btn-outline-danger",children:"Close"})]})]}),i("div",{className:"flex-1 p-4 overflow-y-auto space-y-4",children:[(Y=r==null?void 0:r.messages)==null?void 0:Y.map((s,p)=>t("div",{className:`flex ${s.senderRole==="admin"?"justify-end":"justify-start"}`,children:i("div",{className:`max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${s.senderRole==="admin"?"bg-blue-500 text-white":"bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white"}`,children:[t("p",{className:"text-sm",children:s.message}),t("p",{className:"text-xs opacity-70 mt-1",children:G(s.timestamp)})]})},p)),k.length>0&&t("div",{className:"flex justify-start",children:t("div",{className:"bg-gray-100 dark:bg-gray-700 px-4 py-2 rounded-lg",children:i("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:[k.map(s=>s.userName).join(", ")," ",k.length===1?"is":"are"," typing..."]})})}),t("div",{ref:f})]}),t("form",{onSubmit:re,className:"p-4 border-t border-gray-200 dark:border-gray-700",children:i("div",{className:"flex items-center space-x-2",children:[t("input",{type:"text",value:a,onChange:ne,placeholder:"Type a message...",className:"flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-slate-700 dark:text-white"}),t(j,{type:"submit",disabled:!a.trim(),className:"btn btn-primary",children:t(P,{icon:"ph:paper-plane-tilt"})})]})})]}):t(B,{className:"h-full flex items-center justify-center",children:i("div",{className:"text-center",children:[t(P,{icon:"ph:chat-circle",className:"text-6xl text-gray-400 mb-4"}),t("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-2",children:"Select a chat to start conversation"}),t("p",{className:"text-gray-500 dark:text-gray-400",children:"Choose a chat from the list to view messages"})]})})})]})]})};export{Re as default};
