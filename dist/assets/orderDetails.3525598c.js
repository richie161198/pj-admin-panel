import{a1 as fe,b as Ne,r as w,Z as M,j as e,L as P,c as s,B as j,C as D,I as A,F as H,Q as T}from"./index.51fda1b3.js";import{h as be,a as ve}from"./orderApi.9762c5d7.js";import{B as G}from"./Badge.51e67e4f.js";import{M as we}from"./Modal.91a756b3.js";import{T as ke}from"./Textinput.b6658c0c.js";import"./hidden.17211275.js";import"./cleave-phone.us.f2a6c368.js";const u=S=>new Intl.NumberFormat("en-IN",{style:"currency",currency:"INR"}).format(S),Le=()=>{var z,Q,J,W,Z,K,V,X,Y,ee,te,se,ae,re,ie;const{id:S}=fe();Ne();const[i,U]=w.exports.useState(null),[p,B]=w.exports.useState(null),[k,O]=w.exports.useState(!1),[E,l]=w.exports.useState(!1),[h,m]=w.exports.useState(!1),[N,C]=w.exports.useState(null),[F,I]=w.exports.useState([]),[ce,{isLoading:R}]=be(),{data:$,isLoading:oe,error:_,refetch:me}=ve({page:1,limit:1e3}),t=(((z=$==null?void 0:$.data)==null?void 0:z.orders)||[]).find(a=>a._id===S);w.exports.useEffect(()=>{(t==null?void 0:t._id)&&(t==null?void 0:t.orderCode)&&(ge(),pe())},[t==null?void 0:t._id,t==null?void 0:t.orderCode]);const ge=async()=>{if(!!(t!=null&&t._id)){O(!0);try{const a=M(),n=await fetch("http://localhost:4000/api/v0/invoices?limit=1000",{method:"GET",headers:{"Content-Type":"application/json",...a&&{Authorization:`Bearer ${a}`}}});if(n.ok){const r=await n.json();if(r.status&&r.data&&Array.isArray(r.data)){const d=r.data.find(c=>c.orderId&&(c.orderId._id===t._id||c.orderId===t._id||typeof c.orderId=="string"&&c.orderId===t._id.toString()));d&&U(d)}}}catch(a){console.error("Error fetching invoice:",a)}finally{O(!1)}}},pe=async()=>{if(!!(t!=null&&t.orderCode)){l(!0);try{const a=M(),n=await fetch("http://localhost:4000/api/v0/shipments/bvc/track/order",{method:"POST",headers:{"Content-Type":"application/json",...a&&{Authorization:`Bearer ${a}`}},body:JSON.stringify({orderCode:t.orderCode})});if(n.ok){const r=await n.json();r.success&&r.data&&B(r.data)}}catch(a){console.error("Error fetching tracking data:",a)}finally{l(!1)}}};if(oe)return e("div",{className:"flex justify-center items-center h-64",children:e(P,{})});if(_)return e("div",{className:"text-center py-8",children:s("p",{className:"text-red-500",children:["Error loading order details: ",_.message]})});if(!t)return s("div",{className:"text-center py-8",children:[e("p",{className:"text-gray-500",children:"Order not found"}),e(j,{onClick:()=>window.history.back(),className:"mt-4",children:"Go Back"})]});const he=a=>{const r={pending:{color:"bg-yellow-100 text-yellow-800",label:"Pending"},processing:{color:"bg-blue-100 text-blue-800",label:"Processing"},shipped:{color:"bg-purple-100 text-purple-800",label:"Shipped"},delivered:{color:"bg-green-100 text-green-800",label:"Delivered"},cancelled:{color:"bg-red-100 text-red-800",label:"Cancelled"},refunded:{color:"bg-gray-100 text-gray-800",label:"Refunded"}}[a]||{color:"bg-gray-100 text-gray-800",label:a};return e(G,{className:`${r.color} border-0`,children:r.label})},q=a=>{const r={pending:{color:"bg-yellow-100 text-yellow-800",label:"Pending"},paid:{color:"bg-green-100 text-green-800",label:"Paid"},failed:{color:"bg-red-100 text-red-800",label:"Failed"},refunded:{color:"bg-gray-100 text-gray-800",label:"Refunded"}}[a]||{color:"bg-gray-100 text-gray-800",label:a};return e(G,{className:`${r.color} border-0`,children:r.label})},ue=a=>{var c,o,g,x,y,f;if(!a)return!1;const n=((g=(o=(c=a.shippingDetails)==null?void 0:c.shippingAddress)==null?void 0:o.state)==null?void 0:g.toUpperCase())||"",r=((f=(y=(x=a.customerDetails)==null?void 0:x.address)==null?void 0:y.state)==null?void 0:f.toUpperCase())||"",d=n||r;return d.includes("TAMIL NADU")||d.includes("TAMILNADU")||d.includes(" TN ")||d.endsWith(" TN")},xe=a=>{var c;if(!a||!a.pricing)return{type:"N/A",amount:0,cgst:0,sgst:0,igst:0,roundedGST:0,roundOff:0,isTamilNadu:!1};const n=((c=a.pricing)==null?void 0:c.totalGST)||0;if(n===0)return{type:"N/A",amount:0,cgst:0,sgst:0,igst:0,roundedGST:0,roundOff:0,isTamilNadu:!1};const r=ue(a),d=n;if(r){const o=d/2,g=d/2;return{type:"CGST + SGST",amount:d,cgst:o,sgst:g,igst:0,roundedGST:d,roundOff:0,isTamilNadu:!0}}else return{type:"IGST",amount:d,cgst:0,sgst:0,igst:d,roundedGST:d,roundOff:0,isTamilNadu:!1}},ye=async()=>{if(!(t!=null&&t.orderCode)){T.error("Order code not found");return}try{T.info("Preparing invoice for download...");const a=M(),n={"Content-Type":"application/json"};a&&(n.Authorization=`Bearer ${a}`);const r=await fetch(`http://localhost:4000/api/v0/invoices/order/${t.orderCode}/download`,{method:"GET",headers:n});if(r.ok){const d=await r.blob(),c=window.URL.createObjectURL(d),o=document.createElement("a");o.href=c,o.download=`Invoice-${t.orderCode}.pdf`,document.body.appendChild(o),o.click(),window.URL.revokeObjectURL(c),document.body.removeChild(o),T.success("Invoice downloaded successfully")}else{const d=await r.json().catch(()=>({}));T.error(d.message||"Failed to download invoice")}}catch(a){console.error("Download error:",a),T.error("Failed to download invoice")}};return s("div",{className:"space-y-6",children:[s("div",{className:"flex justify-between items-center",children:[s("div",{children:[e("h1",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:"Order Details"}),s("p",{className:"text-gray-600 dark:text-gray-400",children:["Order ID: ",t.orderCode]})]}),s("div",{className:"flex items-center gap-4",children:[he(t.status),q(t.paymentStatus)]})]}),s("div",{className:"grid grid-cols-1 xl:grid-cols-3 gap-6",children:[s("div",{className:"xl:col-span-2 space-y-6",children:[e(D,{title:"Products ordered",bodyClass:"p-0",children:e("div",{className:"divide-y",children:(Q=t.items)==null?void 0:Q.map((a,n)=>{var o,g,x,y,f,ne;const r=(o=i==null?void 0:i.products)==null?void 0:o.find(L=>{var le,de;const b=((le=a.productDataid)==null?void 0:le._id)||a.productDataid,v=((de=L.productId)==null?void 0:de._id)||L.productId;return typeof b=="string"&&b===(v==null?void 0:v.toString())||typeof v=="string"&&v===(b==null?void 0:b.toString())||(b==null?void 0:b.toString())===(v==null?void 0:v.toString())}),d=(r==null?void 0:r.finalPrice)||(r==null?void 0:r.totalPrice)||a.price||0,c=(r==null?void 0:r.unitPrice)||(a.price&&a.quantity?a.price/a.quantity:0);return s("div",{className:"p-5 hover:bg-gray-50 dark:hover:bg-slate-800/40 transition-colors",children:[s("div",{className:"flex items-center justify-between mb-3",children:[s("div",{className:"flex items-center gap-4",children:[e("img",{src:((x=(g=a.productDataid)==null?void 0:g.images)==null?void 0:x[0])||"/placeholder-product.jpg",alt:((y=a.productDataid)==null?void 0:y.name)||(r==null?void 0:r.name)||"Product",className:"w-14 h-14 rounded-md object-cover ring-1 ring-gray-200"}),s("div",{children:[e("div",{className:"font-medium text-gray-900 dark:text-gray-100",children:((f=a.productDataid)==null?void 0:f.name)||(r==null?void 0:r.name)||"Product"}),s("div",{className:"text-xs text-gray-500",children:["Brand: ",((ne=a.productDataid)==null?void 0:ne.brand)||(r==null?void 0:r.brand)||"N/A"]}),r&&s("div",{className:"text-xs text-gray-400 mt-1",children:["Unit Price: ",u(c)]})]})]}),s("div",{className:"text-right",children:[e("div",{className:"font-semibold text-gray-900 dark:text-gray-100",children:u(d)}),s("div",{className:"text-xs text-gray-500",children:["Qty: ",a.quantity||(r==null?void 0:r.quantity)||1]}),r&&r.quantity>1&&s("div",{className:"text-xs text-gray-400",children:["(",u(c)," \xD7 ",r.quantity,")"]})]})]}),t.status==="CONFIRMED"&&s("div",{className:"mt-3 pt-3 border-t border-gray-200 dark:border-gray-700",children:[s("div",{className:"flex items-center justify-between mb-2",children:[e("div",{className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:"HUID (Hallmark Unique ID)"}),s(j,{onClick:()=>{C(n),I(a.huids&&a.huids.length>0?[...a.huids]:Array(a.quantity||1).fill("")),m(!0)},className:"btn btn-sm btn-outline-primary",size:"sm",children:[e(A,{icon:"ph:pencil",className:"mr-1"}),a.huids&&a.huids.length>0?"Edit":"Add"," HUID"]})]}),a.huids&&a.huids.length>0?e("div",{className:"flex flex-wrap gap-2",children:a.huids.map((L,b)=>e(G,{className:"bg-blue-100 text-blue-800 border-0",children:L},b))}):e("div",{className:"text-xs text-gray-500 italic",children:"No HUIDs added yet"})]})]},n)})})}),s(D,{title:s("div",{className:"flex items-center gap-2",children:[e("span",{children:"Payment"}),q(t.paymentStatus)]}),bodyClass:"p-0",children:[s("div",{className:"p-5 space-y-3",children:[(()=>{const a=xe(i||t),n=a.isTamilNadu,r=a.roundedGST;return r>0?s(H,{children:[n?s(H,{children:[s("div",{className:"flex items-center justify-between text-sm",children:[e("span",{className:"text-gray-600 dark:text-gray-400",children:"CGST (1.5%)"}),e("span",{className:"font-medium text-gray-900 dark:text-white",children:u(a.cgst)})]}),s("div",{className:"flex items-center justify-between text-sm",children:[e("span",{className:"text-gray-600 dark:text-gray-400",children:"SGST (1.5%)"}),e("span",{className:"font-medium text-gray-900 dark:text-white",children:u(a.sgst)})]})]}):s("div",{className:"flex items-center justify-between text-sm",children:[e("span",{className:"text-gray-600 dark:text-gray-400",children:"IGST (3%)"}),e("span",{className:"font-medium text-gray-900 dark:text-white",children:u(a.igst)})]}),s("div",{className:"flex items-center justify-between text-sm",children:[e("span",{className:"text-gray-600 dark:text-gray-400 font-medium",children:"Total GST"}),e("span",{className:"font-medium text-gray-900 dark:text-white",children:u(r)})]})]}):s("div",{className:"flex items-center justify-between text-sm",children:[e("span",{className:"text-gray-600 dark:text-gray-400",children:"GST"}),e("span",{className:"font-medium text-gray-900 dark:text-white",children:u(0)})]})})(),s("div",{className:"flex items-center justify-between text-sm",children:[e("span",{className:"text-gray-600 dark:text-gray-400 font-medium",children:"Total"}),e("span",{className:"font-medium text-gray-900 dark:text-white",children:u(((J=i==null?void 0:i.pricing)==null?void 0:J.grandTotal)||((W=t.pricing)==null?void 0:W.grandTotal)||t.totalAmount||0)})]}),s("div",{className:"flex items-center justify-between text-sm",children:[e("span",{className:"text-gray-600 dark:text-gray-400",children:"Shipping Charges"}),e("span",{className:"font-medium text-gray-900 dark:text-white",children:u(((Z=i==null?void 0:i.shippingDetails)==null?void 0:Z.shippingPrice)||((K=i==null?void 0:i.shippingDetails)==null?void 0:K.shippingAmount)||((V=t.shippingDetails)==null?void 0:V.shippingPrice)||((X=t.shippingDetails)==null?void 0:X.shippingAmount)||0)})]}),s("div",{className:"border-t pt-3 flex items-center justify-between",children:[e("span",{className:"font-semibold text-gray-900 dark:text-white",children:"Total Amount"}),e("span",{className:"font-semibold text-gray-900 dark:text-white",children:(()=>{var c,o,g,x,y,f;const a=((c=i==null?void 0:i.pricing)==null?void 0:c.grandTotal)||((o=t.pricing)==null?void 0:o.grandTotal)||t.totalAmount||0,n=((g=i==null?void 0:i.shippingDetails)==null?void 0:g.shippingPrice)||((x=i==null?void 0:i.shippingDetails)==null?void 0:x.shippingAmount)||((y=t.shippingDetails)==null?void 0:y.shippingPrice)||((f=t.shippingDetails)==null?void 0:f.shippingAmount)||0,r=a+n,d=Math.ceil(r);return u(d)})()})]})]}),s("div",{className:"px-5 py-3 bg-gray-50 dark:bg-slate-800/40 rounded-b-xl flex items-center justify-between",children:[e("span",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Customer payment"}),e("span",{className:"font-semibold text-gray-900 dark:text-white",children:(()=>{var c,o,g,x,y,f;const a=((c=i==null?void 0:i.pricing)==null?void 0:c.grandTotal)||((o=t.pricing)==null?void 0:o.grandTotal)||t.totalAmount||0,n=((g=i==null?void 0:i.shippingDetails)==null?void 0:g.shippingPrice)||((x=i==null?void 0:i.shippingDetails)==null?void 0:x.shippingAmount)||((y=t.shippingDetails)==null?void 0:y.shippingPrice)||((f=t.shippingDetails)==null?void 0:f.shippingAmount)||0,r=a+n,d=Math.ceil(r);return u(d)})()})]})]})]}),s("div",{className:"space-y-6",children:[e(D,{title:"Customer",bodyClass:"p-0",children:s("div",{className:"p-5 space-y-5",children:[e("div",{className:"flex items-center gap-3",children:s("div",{children:[e("div",{className:"font-medium text-gray-900 dark:text-gray-100",children:((Y=t.user)==null?void 0:Y.name)||"N/A"}),e("div",{className:"text-xs text-gray-500",children:((ee=t.user)==null?void 0:ee.id)||"N/A"})]})}),s("div",{className:"divide-y",children:[s("div",{className:"py-4 flex items-center gap-3",children:[e(A,{icon:"solar:inbox-line-duotone",className:"text-xl text-gray-500"}),e("span",{className:"text-sm",children:((te=t.user)==null?void 0:te.email)||"N/A"})]}),s("div",{className:"py-4 flex items-center gap-3",children:[e(A,{icon:"solar:phone-linear",className:"text-xl text-gray-500"}),e("span",{className:"text-sm",children:((se=t.user)==null?void 0:se.phone)||"N/A"})]})]}),t.shippingAddress&&s("div",{className:"pt-2",children:[e("div",{className:"text-sm font-semibold mb-2",children:"Shipping Address"}),s("div",{className:"text-sm text-gray-600 space-y-1",children:[e("div",{children:t.shippingAddress.street||""}),s("div",{children:[t.shippingAddress.city||"",", ",t.shippingAddress.state||""]}),e("div",{children:t.shippingAddress.zipCode||""}),e("div",{children:t.shippingAddress.country||""})]})]}),t.billingAddress&&s("div",{className:"pt-4 border-t",children:[e("div",{className:"text-sm font-semibold mb-2",children:"Billing Address"}),s("div",{className:"text-sm text-gray-600 space-y-1",children:[e("div",{children:t.billingAddress.street||""}),s("div",{children:[t.billingAddress.city||"",", ",t.billingAddress.state||""]}),e("div",{children:t.billingAddress.zipCode||""}),e("div",{children:t.billingAddress.country||""})]})]})]})}),e(D,{title:"Order Information",children:s("div",{className:"space-y-3",children:[s("div",{className:"flex justify-between",children:[e("span",{className:"text-sm text-gray-600",children:"Created"}),e("span",{className:"text-sm font-medium",children:t.createdAt?new Date(t.createdAt).toLocaleDateString():"N/A"})]}),s("div",{className:"flex justify-between",children:[e("span",{className:"text-sm text-gray-600",children:"Updated"}),e("span",{className:"text-sm font-medium",children:t.updatedAt?new Date(t.updatedAt).toLocaleDateString():"N/A"})]}),s("div",{className:"flex justify-between",children:[e("span",{className:"text-sm text-gray-600",children:"Items"}),e("span",{className:"text-sm font-medium",children:((ae=t.items)==null?void 0:ae.length)||0})]}),((re=i==null?void 0:i.customerDetails)==null?void 0:re.address)&&s("div",{className:"pt-2 border-t",children:[e("div",{className:"text-sm text-gray-600 mb-1",children:"Billing Address:"}),s("div",{className:"text-sm font-medium text-gray-900 dark:text-gray-100",children:[i.customerDetails.address.street&&e("div",{children:i.customerDetails.address.street}),i.customerDetails.address.city&&s("div",{children:[i.customerDetails.address.city,i.customerDetails.address.state&&`, ${i.customerDetails.address.state}`,i.customerDetails.address.pincode&&` - ${i.customerDetails.address.pincode}`]}),!i.customerDetails.address.street&&!i.customerDetails.address.city&&"N/A"]})]})]})}),e(D,{title:"Actions",children:e("div",{className:"space-y-3",children:s(j,{onClick:ye,className:"btn btn-primary w-full",children:[e(A,{icon:"ph:file-text",className:"mr-2"}),"Download Invoice"]})})})]})]}),t&&e(D,{title:"Shipment Tracking",children:E?e("div",{className:"flex justify-center items-center py-8",children:e(P,{})}):(p==null?void 0:p.trackingHistory)&&p.trackingHistory.length>0?e(Te,{trackingHistory:p.trackingHistory,statusLabel:p.statusLabel||p.status,docketNo:p.docketNo,orderDate:t.createdAt}):s("div",{className:"text-center py-8 text-gray-500",children:[e(A,{icon:"solar:box-line-duotone",className:"text-4xl mx-auto mb-2 opacity-50"}),e("p",{children:"No tracking information available"})]})}),e(we,{title:"Manage HUIDs",label:"huid-modal",activeModal:h,onClose:()=>{m(!1),C(null),I([])},children:N!==null&&t.items[N]&&s("div",{className:"space-y-4",children:[s("div",{className:"bg-gray-50 dark:bg-slate-700 p-3 rounded-lg",children:[e("p",{className:"text-sm font-medium text-gray-900 dark:text-gray-100",children:((ie=t.items[N].productDataid)==null?void 0:ie.name)||"Product"}),s("p",{className:"text-xs text-gray-600 dark:text-gray-400 mt-1",children:["Quantity: ",t.items[N].quantity||1]})]}),s("div",{className:"space-y-3",children:[e("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Enter HUIDs (one per quantity):"}),F.map((a,n)=>s("div",{className:"flex items-center gap-2",children:[s("span",{className:"text-sm text-gray-600 dark:text-gray-400 w-8",children:["#",n+1,":"]}),e(ke,{type:"text",value:a,onChange:r=>{const d=[...F];d[n]=r.target.value.toUpperCase().trim(),I(d)},placeholder:`HUID ${n+1}`,className:"flex-1",maxLength:16})]},n))]}),s("div",{className:"flex justify-end space-x-3 pt-4 border-t",children:[e(j,{onClick:()=>{m(!1),C(null),I([])},className:"btn btn-outline-secondary",children:"Cancel"}),e(j,{onClick:async()=>{var a;try{await ce({orderId:t._id,itemIndex:N,huids:F}).unwrap(),T.success("HUIDs updated successfully"),m(!1),C(null),I([]),me()}catch(n){console.error("Failed to update HUIDs:",n),T.error(((a=n==null?void 0:n.data)==null?void 0:a.error)||"Failed to update HUIDs")}},disabled:R,className:"btn btn-primary",children:R?s(H,{children:[e(P,{}),e("span",{className:"ml-2",children:"Saving..."})]}):s(H,{children:[e(A,{icon:"ph:floppy-disk",className:"mr-2"}),"Save HUIDs"]})})]})]})})]})},Te=({trackingHistory:S,statusLabel:i,docketNo:U,orderDate:p})=>{const B=[...S].sort((l,h)=>{const m=l.timestamp?new Date(l.timestamp).getTime():0,N=h.timestamp?new Date(h.timestamp).getTime():0;return m-N}),k=[];p&&k.push({status:"Ordered",statusCode:"ORDERED",date:new Date(p).toLocaleDateString("en-IN",{day:"2-digit",month:"short",year:"numeric"}),time:new Date(p).toLocaleTimeString("en-IN",{hour:"2-digit",minute:"2-digit"}),city:"",isOrdered:!0}),B.forEach(l=>{k.push({status:l.status||"Unknown",statusCode:l.statusCode||"",date:l.date||"",time:l.time||"",city:l.city||"",timestamp:l.timestamp})});const O=l=>{if(!l)return"solar:info-circle-line-duotone";switch(l.toUpperCase()){case"AP":return"solar:box-line-duotone";case"OP":return"solar:delivery-line-duotone";case"NP":return"solar:danger-triangle-line-duotone";case"CP":return"solar:close-circle-line-duotone";case"IT":return"solar:delivery-line-duotone";case"OFD":return"solar:delivery-line-duotone";case"DL":return"solar:check-circle-line-duotone";case"ORDERED":return"solar:cart-line-duotone";default:return"solar:info-circle-line-duotone"}},E=(l,h)=>{if(!l)return"text-blue-500";const m=l.toUpperCase();if(h)switch(m){case"DL":return"text-green-500";case"CP":case"NP":return"text-red-500";case"OFD":return"text-orange-500";default:return"text-blue-500"}return"text-blue-500"};return s("div",{className:"space-y-4",children:[s("div",{className:"flex items-center justify-between",children:[s("div",{children:[e("h3",{className:"font-semibold text-gray-900 dark:text-white",children:"Track Order"}),U&&s("p",{className:"text-sm text-gray-500 mt-1",children:["Docket: ",U]})]}),e(G,{className:"bg-blue-100 text-blue-800 border-0",children:i})]}),e("div",{className:"relative",children:k.map((l,h)=>{const m=h===k.length-1,N=h<k.length-1,C=E(l.statusCode,m);return s("div",{className:"relative flex gap-4 pb-6 last:pb-0",children:[h<k.length-1&&e("div",{className:"absolute left-4 top-8 bottom-0 w-0.5 bg-gray-200 dark:bg-gray-700"}),e("div",{className:`relative z-10 flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center ${N||m?"bg-blue-500 text-white":"bg-gray-200 dark:bg-gray-700 text-gray-400"}`,children:e(A,{icon:O(l.statusCode),className:`text-lg ${N||m?"text-white":C}`})}),e("div",{className:"flex-1 pt-1",children:s("div",{className:"flex items-start justify-between",children:[s("div",{children:[e("p",{className:`font-medium ${m?"text-blue-600 dark:text-blue-400":"text-gray-900 dark:text-gray-100"}`,children:l.status}),l.city&&e("p",{className:"text-sm text-gray-500 mt-0.5",children:l.city})]}),s("div",{className:"text-right text-sm text-gray-500",children:[l.date&&e("div",{children:l.date}),l.time&&e("div",{children:l.time})]})]})})]},h)})})]})};export{Le as default};
